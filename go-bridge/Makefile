# Panasonic FZ-G1 Volume Bridge Makefile

# é…ç½®
BINARY_NAME=panasonic-volume-bridge
BUILD_DIR=build
INSTALL_DIR=/usr/local/bin
SERVICE_NAME=panasonic-volume-bridge.service
SERVICE_DIR=/etc/systemd/system

# Goæ„å»ºæ ‡å¿—
LDFLAGS=-ldflags "-X main.version=$(shell git describe --tags --always --dirty 2>/dev/null || echo 'dev')"

.PHONY: all build clean install uninstall service-install service-uninstall service-start service-stop service-restart service-status

# é»˜è®¤ç›®æ ‡
all: build

# ç¼–è¯‘
build:
	@echo "ğŸ”¨ ç¼–è¯‘ $(BINARY_NAME)..."
	@mkdir -p $(BUILD_DIR)
	@go mod tidy
	@CGO_ENABLED=0 GOOS=linux go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) .
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(BUILD_DIR)/$(BINARY_NAME)"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR)
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
install: build
	@echo "ğŸ“¦ å®‰è£… $(BINARY_NAME) åˆ° $(INSTALL_DIR)..."
	@sudo cp $(BUILD_DIR)/$(BINARY_NAME) $(INSTALL_DIR)/
	@sudo chmod +x $(INSTALL_DIR)/$(BINARY_NAME)
	@echo "âœ… å®‰è£…å®Œæˆ"

# å¸è½½äºŒè¿›åˆ¶æ–‡ä»¶
uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½ $(BINARY_NAME)..."
	@sudo rm -f $(INSTALL_DIR)/$(BINARY_NAME)
	@echo "âœ… å¸è½½å®Œæˆ"

# å®‰è£…ç³»ç»ŸæœåŠ¡
service-install: install
	@echo "ğŸ”§ å®‰è£…ç³»ç»ŸæœåŠ¡..."
	@sudo cp ../scripts/$(SERVICE_NAME) $(SERVICE_DIR)/
	@sudo systemctl daemon-reload
	@echo "âœ… ç³»ç»ŸæœåŠ¡å·²å®‰è£…"

# å¸è½½ç³»ç»ŸæœåŠ¡
service-uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½ç³»ç»ŸæœåŠ¡..."
	@sudo systemctl stop $(SERVICE_NAME) 2>/dev/null || true
	@sudo systemctl disable $(SERVICE_NAME) 2>/dev/null || true
	@sudo rm -f $(SERVICE_DIR)/$(SERVICE_NAME)
	@sudo systemctl daemon-reload
	@echo "âœ… ç³»ç»ŸæœåŠ¡å·²å¸è½½"

# å¯åŠ¨æœåŠ¡
service-start:
	@echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
	@sudo systemctl start $(SERVICE_NAME)
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"

# åœæ­¢æœåŠ¡
service-stop:
	@echo "â¹ï¸  åœæ­¢æœåŠ¡..."
	@sudo systemctl stop $(SERVICE_NAME)
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

# é‡å¯æœåŠ¡
service-restart:
	@echo "ğŸ”„ é‡å¯æœåŠ¡..."
	@sudo systemctl restart $(SERVICE_NAME)
	@echo "âœ… æœåŠ¡å·²é‡å¯"

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
service-status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@sudo systemctl status $(SERVICE_NAME)

# å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
service-enable:
	@echo "ğŸš€ å¯ç”¨å¼€æœºè‡ªå¯..."
	@sudo systemctl enable $(SERVICE_NAME)
	@echo "âœ… å¼€æœºè‡ªå¯å·²å¯ç”¨"

# ç¦ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
service-disable:
	@echo "ğŸ›‘ ç¦ç”¨å¼€æœºè‡ªå¯..."
	@sudo systemctl disable $(SERVICE_NAME)
	@echo "âœ… å¼€æœºè‡ªå¯å·²ç¦ç”¨"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
service-logs:
	@echo "ğŸ“‹ æœåŠ¡æ—¥å¿—:"
	@sudo journalctl -u $(SERVICE_NAME) -f

# ä¸€é”®éƒ¨ç½²
deploy: service-install service-enable service-start
	@echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼æœåŠ¡å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯"

# å®Œå…¨å¸è½½
remove: service-uninstall uninstall
	@echo "ğŸ—‘ï¸  å®Œå…¨å¸è½½å®Œæˆ"

# å¼€å‘æ¨¡å¼è¿è¡Œ
dev:
	@echo "ğŸ§ª å¼€å‘æ¨¡å¼è¿è¡Œ..."
	@go run .

# æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Panasonic FZ-G1 Volume Bridge Makefile"
	@echo ""
	@echo "æ„å»ºå‘½ä»¤:"
	@echo "  make build        - ç¼–è¯‘ç¨‹åº"
	@echo "  make clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make install      - å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  make uninstall    - å¸è½½äºŒè¿›åˆ¶æ–‡ä»¶"
	@echo ""
	@echo "æœåŠ¡ç®¡ç†:"
	@echo "  make service-install   - å®‰è£…ç³»ç»ŸæœåŠ¡"
	@echo "  make service-uninstall - å¸è½½ç³»ç»ŸæœåŠ¡"
	@echo "  make service-start     - å¯åŠ¨æœåŠ¡"
	@echo "  make service-stop      - åœæ­¢æœåŠ¡"
	@echo "  make service-restart   - é‡å¯æœåŠ¡"
	@echo "  make service-status    - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make service-enable    - å¯ç”¨å¼€æœºè‡ªå¯"
	@echo "  make service-disable   - ç¦ç”¨å¼€æœºè‡ªå¯"
	@echo "  make service-logs      - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo ""
	@echo "å¿«æ·å‘½ä»¤:"
	@echo "  make deploy       - ä¸€é”®éƒ¨ç½²(å®‰è£…+å¯ç”¨+å¯åŠ¨)"
	@echo "  make remove       - å®Œå…¨å¸è½½"
	@echo "  make dev          - å¼€å‘æ¨¡å¼è¿è¡Œ"
	@echo "  make test         - è¿è¡Œæµ‹è¯•" 